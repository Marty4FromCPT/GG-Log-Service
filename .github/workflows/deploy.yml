on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'functions/**'

name: Deploy Serverless Functions Only

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'

permissions:
  id-token: write
  contents: read

jobs:
  update-lambdas:
    name: Upload Lambda Code to AWS
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v2
      with:
          role-to-assume: arn:aws:iam::211125452025:role/GitHubActionsLambdaDeploy
          aws-region: us-east-1

    - name: Zip submit_log Lambda
      run: |
        cd functions/submit_log
        zip -r ../../submit_log.zip handler.py

    - name: Zip get_logs Lambda
      run: |
        cd functions/get_logs
        zip -r ../../get_logs.zip handler.py

    - name: Upload submit_log to Lambda
      run: |
        aws lambda update-function-code \
          --function-name submit-log-function \
          --zip-file fileb://submit_log.zip

    - name: Upload get_logs to Lambda
      run: |
        aws lambda update-function-code \
          --function-name get-logs-function \
          --zip-file fileb://get_logs.zip
